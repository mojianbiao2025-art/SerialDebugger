<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸²å£è°ƒè¯•åŠ©æ‰‹ - Serial Debugger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        #status {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 800px;
            width: 100%;
        }
        #canvas {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
        }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .warning { background: #fff3e0; color: #ef6c00; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”Œ ä¸²å£è°ƒè¯•åŠ©æ‰‹</h1>
        <p>Serial Port Debugger - WebAssembly Version</p>
    </div>

    <div id="status">
        <h3>åŠ è½½çŠ¶æ€</h3>
        <div id="logs"></div>
    </div>

    <canvas id="canvas" width="1200" height="800"></canvas>

    <script>
        var logs = document.getElementById('logs');
        var canvas = document.getElementById('canvas');
        var loadStartTime = Date.now();

        function log(message, type = 'info') {
            var timestamp = new Date().toLocaleTimeString();
            var elapsed = ((Date.now() - loadStartTime) / 1000).toFixed(1);
            var div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = '[' + elapsed + 's] ' + message;
            logs.appendChild(div);
            console.log('[' + elapsed + 's]', message);
            logs.scrollTop = logs.scrollHeight;
        }

        // æ£€æŸ¥åŸºæœ¬æ”¯æŒ
        log('æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...', 'info');
        
        if (typeof WebAssembly === 'undefined') {
            log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebAssemblyï¼', 'error');
        } else {
            log('âœ“ WebAssembly æ”¯æŒ', 'success');
        }

        if ('serial' in navigator) {
            log('âœ“ Web Serial API æ”¯æŒ', 'success');
        } else {
            log('âš  Web Serial API ä¸æ”¯æŒï¼ˆéœ€è¦ Chrome 89+ï¼‰', 'warning');
        }

        // é…ç½® Module
        log('é…ç½® WebAssembly æ¨¡å—...', 'info');
        
        var Module = {
            preRun: [],
            postRun: [],
            print: function(text) {
                log('[Qt] ' + text, 'info');
            },
            printErr: function(text) {
                log('[Qt Error] ' + text, 'error');
            },
            canvas: canvas,
            setStatus: function(text) {
                if (text) {
                    log(text, 'info');
                } else {
                    log('âœ“ åº”ç”¨åŠ è½½å®Œæˆ', 'success');
                    document.getElementById('status').style.display = 'none';
                    canvas.style.display = 'block';
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                if (left) {
                    log('åŠ è½½ä¾èµ– (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')', 'info');
                } else {
                    log('âœ“ æ‰€æœ‰ä¾èµ–å·²åŠ è½½', 'success');
                }
            },
            onRuntimeInitialized: function() {
                log('âœ“ è¿è¡Œæ—¶åˆå§‹åŒ–å®Œæˆ', 'success');
            },
            onAbort: function(what) {
                log('âŒ åº”ç”¨ä¸­æ­¢: ' + what, 'error');
            }
        };

        // é”™è¯¯å¤„ç†
        window.onerror = function(msg, url, line, col, error) {
            log('âŒ JavaScript é”™è¯¯: ' + msg, 'error');
            if (url) log('   ä½ç½®: ' + url + ':' + line, 'error');
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            log('âŒ Promise é”™è¯¯: ' + event.reason, 'error');
        });

        // å¼€å§‹åŠ è½½
        log('å¼€å§‹åŠ è½½ SerialDebugger.js...', 'info');
        Module.setStatus('æ­£åœ¨ä¸‹è½½åº”ç”¨...');

        // åŠ¨æ€åŠ è½½è„šæœ¬
        var script = document.createElement('script');
        script.src = 'SerialDebugger.js';
        script.onerror = function() {
            log('âŒ æ— æ³•åŠ è½½ SerialDebugger.js', 'error');
            log('è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥', 'error');
        };
        script.onload = function() {
            log('âœ“ SerialDebugger.js å·²åŠ è½½', 'success');
        };
        document.body.appendChild(script);

        // è¶…æ—¶æ£€æµ‹
        setTimeout(function() {
            if (canvas.style.display === 'none') {
                log('âš  åŠ è½½è¶…æ—¶ï¼ˆ30ç§’ï¼‰', 'warning');
                log('å¯èƒ½çš„åŸå› ï¼š', 'warning');
                log('1. ç½‘ç»œè¿æ¥æ…¢', 'warning');
                log('2. .wasm æ–‡ä»¶å¤ªå¤§', 'warning');
                log('3. æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜', 'warning');
                log('å»ºè®®ï¼šåˆ·æ–°é¡µé¢æˆ–æ¸…é™¤ç¼“å­˜åé‡è¯•', 'warning');
            }
        }, 30000);
    </script>
</body>
</html>
