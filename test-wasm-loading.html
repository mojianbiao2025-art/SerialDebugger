<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebAssembly åŠ è½½è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <h2>1. ç¯å¢ƒæ£€æŸ¥</h2>
            <div id="env-check">
                <div class="spinner"></div> æ­£åœ¨æ£€æŸ¥...
            </div>
        </div>

        <div class="test-section">
            <h2>2. æ–‡ä»¶æ£€æŸ¥</h2>
            <div id="file-check">
                <div class="spinner"></div> æ­£åœ¨æ£€æŸ¥...
            </div>
        </div>

        <div class="test-section">
            <h2>3. æµè§ˆå™¨èƒ½åŠ›æ£€æŸ¥</h2>
            <div id="capability-check">
                <div class="spinner"></div> æ­£åœ¨æ£€æŸ¥...
            </div>
        </div>

        <div class="test-section">
            <h2>4. æ“ä½œå»ºè®®</h2>
            <div id="suggestions"></div>
        </div>

        <div class="test-section">
            <h2>5. è¯¦ç»†æ—¥å¿—</h2>
            <button onclick="copyLogs()">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
            <button onclick="downloadLogs()">ğŸ’¾ ä¸‹è½½æ—¥å¿—</button>
            <div id="detailed-log" style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        var allLogs = [];

        function log(message, type) {
            var timestamp = new Date().toISOString();
            var logEntry = {
                timestamp: timestamp,
                message: message,
                type: type || 'info'
            };
            allLogs.push(logEntry);
            
            var logDiv = document.getElementById('detailed-log');
            var entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(message);
        }

        function addResult(containerId, message, type) {
            var container = document.getElementById(containerId);
            var div = document.createElement('div');
            div.className = 'test-item ' + type;
            div.innerHTML = message;
            
            if (container.querySelector('.spinner')) {
                container.innerHTML = '';
            }
            container.appendChild(div);
        }

        function copyLogs() {
            var text = allLogs.map(l => '[' + l.timestamp + '] ' + l.message).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function downloadLogs() {
            var text = allLogs.map(l => '[' + l.timestamp + '] ' + l.message).join('\n');
            var blob = new Blob([text], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'wasm-diagnostic-' + Date.now() + '.log';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 1. Environment Check
        log('å¼€å§‹ç¯å¢ƒæ£€æŸ¥');
        var protocol = window.location.protocol;
        var hostname = window.location.hostname;
        var port = window.location.port;
        var fullUrl = window.location.href;

        log('åè®®: ' + protocol);
        log('ä¸»æœº: ' + hostname);
        log('ç«¯å£: ' + port);
        log('å®Œæ•´URL: ' + fullUrl);

        if (protocol === 'file:') {
            addResult('env-check', 'âŒ ä½¿ç”¨ file:// åè®® - è¿™ä¼šå¯¼è‡´ CORS é”™è¯¯ï¼', 'error');
            log('é”™è¯¯: ä½¿ç”¨ file:// åè®®', 'error');
        } else if (protocol === 'https:') {
            addResult('env-check', 'âœ… ä½¿ç”¨ HTTPS åè®® - å®Œç¾ï¼', 'success');
            log('æˆåŠŸ: ä½¿ç”¨ HTTPS åè®®', 'success');
        } else if (protocol === 'http:' && (hostname === 'localhost' || hostname === '127.0.0.1')) {
            addResult('env-check', 'âœ… ä½¿ç”¨æœ¬åœ° HTTP æœåŠ¡å™¨ - å¯ä»¥å·¥ä½œ', 'success');
            log('æˆåŠŸ: ä½¿ç”¨æœ¬åœ° HTTP æœåŠ¡å™¨', 'success');
        } else {
            addResult('env-check', 'âš ï¸ ä½¿ç”¨ HTTP åè®® - Web Serial API å¯èƒ½ä¸å¯ç”¨', 'warning');
            log('è­¦å‘Š: ä½¿ç”¨ HTTP åè®®ï¼ˆéæœ¬åœ°ï¼‰', 'warning');
        }

        // 2. File Check
        log('å¼€å§‹æ–‡ä»¶æ£€æŸ¥');
        var filesToCheck = [
            'SerialDebugger.js',
            'SerialDebugger.wasm',
            'index.html',
            'lang_zh.ini',
            'lang_en.ini',
            'styles.qss'
        ];

        var fileCheckPromises = filesToCheck.map(file => {
            log('æ£€æŸ¥æ–‡ä»¶: ' + file);
            return fetch(file, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        var size = response.headers.get('content-length');
                        var sizeStr = size ? ' (' + (size / 1024).toFixed(2) + ' KB)' : '';
                        var message = 'âœ… ' + file + sizeStr;
                        addResult('file-check', message, 'success');
                        log('æˆåŠŸ: ' + file + ' æ‰¾åˆ°' + sizeStr, 'success');
                        return { file: file, status: 'ok', size: size };
                    } else {
                        var message = 'âŒ ' + file + ' - HTTP ' + response.status;
                        addResult('file-check', message, 'error');
                        log('é”™è¯¯: ' + file + ' HTTP ' + response.status, 'error');
                        return { file: file, status: 'error', code: response.status };
                    }
                })
                .catch(error => {
                    var message = 'âŒ ' + file + ' - ' + error.message;
                    addResult('file-check', message, 'error');
                    log('é”™è¯¯: ' + file + ' - ' + error.message, 'error');
                    return { file: file, status: 'error', error: error.message };
                });
        });

        // 3. Capability Check
        log('å¼€å§‹æµè§ˆå™¨èƒ½åŠ›æ£€æŸ¥');
        
        // Web Serial API
        if ('serial' in navigator) {
            addResult('capability-check', 'âœ… Web Serial API æ”¯æŒ', 'success');
            log('æˆåŠŸ: Web Serial API æ”¯æŒ', 'success');
        } else {
            addResult('capability-check', 'âŒ Web Serial API ä¸æ”¯æŒ', 'error');
            log('é”™è¯¯: Web Serial API ä¸æ”¯æŒ', 'error');
        }

        // WebAssembly
        if (typeof WebAssembly === 'object') {
            addResult('capability-check', 'âœ… WebAssembly æ”¯æŒ', 'success');
            log('æˆåŠŸ: WebAssembly æ”¯æŒ', 'success');
        } else {
            addResult('capability-check', 'âŒ WebAssembly ä¸æ”¯æŒ', 'error');
            log('é”™è¯¯: WebAssembly ä¸æ”¯æŒ', 'error');
        }

        // WebGL
        var canvas = document.createElement('canvas');
        var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (gl) {
            addResult('capability-check', 'âœ… WebGL æ”¯æŒ', 'success');
            log('æˆåŠŸ: WebGL æ”¯æŒ', 'success');
        } else {
            addResult('capability-check', 'âŒ WebGL ä¸æ”¯æŒ', 'error');
            log('é”™è¯¯: WebGL ä¸æ”¯æŒ', 'error');
        }

        // Browser info
        var userAgent = navigator.userAgent;
        var browserInfo = 'æµè§ˆå™¨: ' + userAgent;
        addResult('capability-check', 'ğŸ“± ' + browserInfo, 'info');
        log('æµè§ˆå™¨ä¿¡æ¯: ' + userAgent, 'info');

        // 4. Generate Suggestions
        Promise.all(fileCheckPromises).then(results => {
            log('æ–‡ä»¶æ£€æŸ¥å®Œæˆ');
            var suggestions = document.getElementById('suggestions');
            var hasErrors = results.some(r => r.status === 'error');
            
            if (protocol === 'file:') {
                suggestions.innerHTML += '<div class="test-item error"><strong>ğŸš¨ å¿…é¡»ä¿®å¤ï¼š</strong><br>' +
                    'æ‚¨æ­£åœ¨ä½¿ç”¨ file:// åè®®è®¿é—®ã€‚è¯·ä½¿ç”¨ HTTP æœåŠ¡å™¨ï¼š<br>' +
                    '<pre>cd deploy\npython -m http.server 8000</pre>' +
                    'ç„¶åè®¿é—®: <code>http://localhost:8000/index.html</code></div>';
                log('å»ºè®®: ä½¿ç”¨ HTTP æœåŠ¡å™¨', 'warning');
            }
            
            if (hasErrors) {
                var missingFiles = results.filter(r => r.status === 'error').map(r => r.file);
                suggestions.innerHTML += '<div class="test-item error"><strong>ğŸš¨ ç¼ºå°‘æ–‡ä»¶ï¼š</strong><br>' +
                    missingFiles.join(', ') + '<br><br>' +
                    'è¯·ç¡®ä¿æ–‡ä»¶å·²æ­£ç¡®éƒ¨ç½²ï¼š<br>' +
                    '<pre>mkdir -p deploy\n' +
                    'cp build-wasm/bin/SerialDebugger.* deploy/\n' +
                    'cp index.html deploy/\n' +
                    'cp lang_*.ini deploy/\n' +
                    'cp styles.qss deploy/</pre></div>';
                log('å»ºè®®: éƒ¨ç½²ç¼ºå¤±çš„æ–‡ä»¶', 'warning');
            }
            
            if (!('serial' in navigator)) {
                suggestions.innerHTML += '<div class="test-item warning"><strong>âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒï¼š</strong><br>' +
                    'è¯·ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ä¹‹ä¸€ï¼š<br>' +
                    'â€¢ Chrome 89+<br>' +
                    'â€¢ Edge 89+<br>' +
                    'â€¢ Opera 75+</div>';
                log('å»ºè®®: ä½¿ç”¨æ”¯æŒçš„æµè§ˆå™¨', 'warning');
            }
            
            if (!hasErrors && protocol !== 'file:' && 'serial' in navigator) {
                suggestions.innerHTML += '<div class="test-item success"><strong>âœ… ç¯å¢ƒæ­£å¸¸ï¼</strong><br>' +
                    'æ‰€æœ‰æ£€æŸ¥é€šè¿‡ã€‚å¦‚æœåº”ç”¨ä»æ— æ³•åŠ è½½ï¼Œè¯·ï¼š<br>' +
                    '1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹é”™è¯¯<br>' +
                    '2. æ£€æŸ¥ Network æ ‡ç­¾æŸ¥çœ‹æ–‡ä»¶åŠ è½½çŠ¶æ€<br>' +
                    '3. å°è¯•æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡æ–°åŠ è½½</div>';
                log('æ‰€æœ‰æ£€æŸ¥é€šè¿‡', 'success');
            }

            // Add link to main app
            suggestions.innerHTML += '<div class="test-item info" style="margin-top: 20px;">' +
                '<strong>ğŸ“± å‡†å¤‡å¥½äº†ï¼Ÿ</strong><br>' +
                '<a href="index.html" style="color: #667eea; font-weight: bold;">ç‚¹å‡»è¿™é‡Œæ‰“å¼€ä¸²å£è°ƒè¯•åŠ©æ‰‹</a></div>';
        });

        log('è¯Šæ–­å®Œæˆ');
    </script>
</body>
</html>
