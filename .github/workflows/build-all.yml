name: Build Android and WebAssembly

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Install Qt for Android
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install aqtinstall==3.1.*
        
        # Install Qt 6.5.3 for desktop (host tools)
        python3 -m aqt install-qt linux desktop 6.5.3 gcc_64 -m qtserialport
        
        # Install Qt 6.5.3 for Android with SerialPort module
        python3 -m aqt install-qt linux android 6.5.3 android_arm64_v8a -m qtserialport
        
        # Set Qt environment
        QT_HOST_PATH=$PWD/6.5.3/gcc_64
        QT_ANDROID_PATH=$PWD/6.5.3/android_arm64_v8a
        
        echo "QT_HOST_PATH=$QT_HOST_PATH" >> $GITHUB_ENV
        echo "Qt6_DIR=$QT_ANDROID_PATH/lib/cmake/Qt6" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$QT_ANDROID_PATH" >> $GITHUB_ENV
        echo "$QT_ANDROID_PATH/bin" >> $GITHUB_PATH
        
        echo "=== Qt Installation Verification ==="
        echo "Qt host installed at: $QT_HOST_PATH"
        echo "Qt Android installed at: $QT_ANDROID_PATH"
        
        echo "=== Checking Qt6 cmake files ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/ | head -20
        
        echo "=== Checking Qt6 Config ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6/ | head -10
        
        echo "=== Checking Qt6Core (CRITICAL) ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6Core/ || echo "Qt6Core NOT FOUND - THIS IS THE PROBLEM!"
        
        echo "=== Checking Qt6SerialPort ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6SerialPort/ || echo "Qt6SerialPort not found"
        
    - name: Install Android SDK and NDK
      run: |
        # Install Android SDK command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        
        # Set Android SDK environment
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        
        # Accept licenses and install components
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3" "ndk;25.1.8937393"
        
        # Set NDK and build tools environment
        echo "ANDROID_NDK_ROOT=$HOME/android-sdk/ndk/25.1.8937393" >> $GITHUB_ENV
        echo "ANDROID_SDK_BUILD_TOOLS_REVISION=30.0.3" >> $GITHUB_ENV
        
    - name: Create build directory
      run: mkdir build-android
      
    - name: Configure CMake
      working-directory: build-android
      run: |
        echo "=== CMake Configuration Starting ==="
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        echo "QT_HOST_PATH: $QT_HOST_PATH"
        echo "Qt6_DIR: $Qt6_DIR"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-23 \
          -DANDROID_SDK_ROOT=$ANDROID_SDK_ROOT \
          -DQT_ANDROID_SDK_BUILD_TOOLS_REVISION=30.0.3 \
          -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=BOTH \
          -DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH \
          -DQT_HOST_PATH=$QT_HOST_PATH \
          -DQt6_DIR=$Qt6_DIR \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared \
          -DCMAKE_FIND_DEBUG_MODE=ON
          
    - name: Build
      working-directory: build-android
      run: |
        # Build the shared library and prepare APK directory
        cmake --build . --config Release --target SerialDebugger -j$(nproc)
        cmake --build . --config Release --target SerialDebugger_prepare_apk_dir
        
        echo "=== Checking build output ==="
        ls -la
        echo "=== Checking for .so file ==="
        find . -name "*.so" -type f
        echo "=== Checking android-build directory ==="
        ls -la android-build/libs/arm64-v8a/ || echo "Directory not found yet"
      
    - name: Create APK with androiddeployqt
      working-directory: build-android
      run: |
        echo "=== Running androiddeployqt ==="
        echo "QT_HOST_PATH: $QT_HOST_PATH"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        
        # First run androiddeployqt to generate files (will fail on gradle but that's ok)
        $QT_HOST_PATH/bin/androiddeployqt \
          --input android-SerialDebugger-deployment-settings.json \
          --output android-build \
          --android-platform android-30 \
          --jdk $JAVA_HOME \
          --gradle \
          --release || true
        
        echo "=== Checking generated build.gradle ==="
        if [ -f android-build/build.gradle ]; then
          echo "First 50 lines of build.gradle:"
          head -50 android-build/build.gradle
          
          # Fix the androidBuildToolsVersion variable if it's not defined
          if ! grep -q "def androidBuildToolsVersion" android-build/build.gradle; then
            echo "Adding androidBuildToolsVersion definition"
            # Create a temporary file with the variable definitions
            cat > /tmp/gradle_vars.txt << 'EOF'
        def androidBuildToolsVersion = "30.0.3"
        def androidCompileSdkVersion = 30
        def androidNdkVersion = "25.1.8937393"
        
        EOF
            # Prepend the variables to the build.gradle file
            cat /tmp/gradle_vars.txt android-build/build.gradle > /tmp/build.gradle.new
            mv /tmp/build.gradle.new android-build/build.gradle
          fi
          
          echo "=== After fix (first 50 lines) ==="
          head -50 android-build/build.gradle
        fi
        
        # Run androiddeployqt again with fixed build.gradle
        $QT_HOST_PATH/bin/androiddeployqt \
          --input android-SerialDebugger-deployment-settings.json \
          --output android-build \
          --android-platform android-30 \
          --jdk $JAVA_HOME \
          --gradle \
          --release
          
    - name: Sign APK
      working-directory: build-android/android-build/build/outputs/apk/release
      run: |
        echo "=== Signing APK ==="
        ls -la
        
        # Create temporary keystore
        keytool -genkey -v -keystore release.keystore \
          -alias release -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass android -keypass android \
          -dname "CN=SerialDebugger, OU=Dev, O=HansCNC, L=Shanghai, S=Shanghai, C=CN"
        
        # Find the unsigned APK
        APK_FILE=$(ls android-build-release-unsigned.apk 2>/dev/null || ls *.apk | head -1)
        echo "Found APK: $APK_FILE"
        
        # Sign APK
        $ANDROID_SDK_ROOT/build-tools/30.0.3/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out SerialDebugger-signed.apk \
          "$APK_FILE"
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-Android-APK
        path: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk

  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-22.04
    needs: build-android  # 等待 Android 构建完成
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip cmake ninja-build
        
    - name: Install Emscripten
      run: |
        cd $HOME
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install 3.1.50
        ./emsdk activate 3.1.50
        
    - name: Install Qt 6 for WebAssembly
      run: |
        pip3 install aqtinstall==3.1.*
        
        # Install Qt 6.5.3 desktop version first (required for WebAssembly)
        aqt install-qt linux desktop 6.5.3 gcc_64
        
        # Install Qt 6.5.3 for WebAssembly (single-threaded)
        aqt install-qt linux desktop 6.5.3 wasm_singlethread
        
        QT_ROOT=$(find $PWD -type d -name "wasm_singlethread" 2>/dev/null | head -1)
        if [ -n "$QT_ROOT" ]; then
          echo "Qt installed at: $QT_ROOT"
          echo "QT_ROOT=$QT_ROOT" >> $GITHUB_ENV
          ls -la $QT_ROOT/lib/cmake/ 2>/dev/null || echo "Cannot list cmake modules"
        else
          echo "ERROR: Qt installation not found!"
          exit 1
        fi
        
    - name: Build WebAssembly
      run: |
        source $HOME/emsdk/emsdk_env.sh
        
        echo "Qt root: $QT_ROOT"
        export CMAKE_PREFIX_PATH=$QT_ROOT
        export PATH=$QT_ROOT/bin:$PATH
        
        mkdir build-wasm
        cd build-wasm
        
        qt-cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release -j2
        
    - name: Prepare deployment
      run: |
        mkdir -p deploy
        cp build-wasm/bin/SerialDebugger.* deploy/
        cp index.html deploy/
        cp test-wasm-loading.html deploy/
        cp test-qt-render.html deploy/
        cp test-webgl.html deploy/
        cp lang_*.ini deploy/
        cp styles.qss deploy/
        
        echo "=== Deployment files ==="
        ls -lh deploy/
        echo "=== Checking critical files ==="
        ls -lh deploy/SerialDebugger.* || echo "WARNING: SerialDebugger files not found!"
        
    - name: Upload WebAssembly build
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-WebAssembly
        path: deploy/
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        force_orphan: true
