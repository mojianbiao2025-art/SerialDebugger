name: Build Android and WebAssembly

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Install Qt for Android
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install aqtinstall==3.1.*
        
        # Install Qt 6.5.3 for desktop (host tools)
        python3 -m aqt install-qt linux desktop 6.5.3 gcc_64 -m qtserialport
        
        # Install Qt 6.5.3 for Android with SerialPort module
        python3 -m aqt install-qt linux android 6.5.3 android_arm64_v8a -m qtserialport
        
        # Set Qt environment
        QT_HOST_PATH=$PWD/6.5.3/gcc_64
        QT_ANDROID_PATH=$PWD/6.5.3/android_arm64_v8a
        
        echo "QT_HOST_PATH=$QT_HOST_PATH" >> $GITHUB_ENV
        echo "Qt6_DIR=$QT_ANDROID_PATH/lib/cmake/Qt6" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$QT_ANDROID_PATH" >> $GITHUB_ENV
        echo "$QT_ANDROID_PATH/bin" >> $GITHUB_PATH
        
        echo "=== Qt Installation Verification ==="
        echo "Qt host installed at: $QT_HOST_PATH"
        echo "Qt Android installed at: $QT_ANDROID_PATH"
        
        echo "=== Checking Qt6 cmake files ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/ | head -20
        
        echo "=== Checking Qt6 Config ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6/ | head -10
        
        echo "=== Checking Qt6Core (CRITICAL) ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6Core/ || echo "Qt6Core NOT FOUND - THIS IS THE PROBLEM!"
        
        echo "=== Checking Qt6SerialPort ==="
        ls -la $QT_ANDROID_PATH/lib/cmake/Qt6SerialPort/ || echo "Qt6SerialPort not found"
        
    - name: Install Android SDK and NDK
      run: |
        # Install Android SDK command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        
        # Set Android SDK environment
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        
        # Accept licenses and install components
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3" "ndk;25.1.8937393"
        
        # Set NDK environment
        echo "ANDROID_NDK_ROOT=$HOME/android-sdk/ndk/25.1.8937393" >> $GITHUB_ENV
        
    - name: Create build directory
      run: mkdir build-android
      
    - name: Configure CMake
      working-directory: build-android
      run: |
        echo "=== CMake Configuration Starting ==="
        echo "CMAKE_PREFIX_PATH: $CMAKE_PREFIX_PATH"
        echo "QT_HOST_PATH: $QT_HOST_PATH"
        echo "Qt6_DIR: $Qt6_DIR"
        
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-23 \
          -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=BOTH \
          -DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH \
          -DQT_HOST_PATH=$QT_HOST_PATH \
          -DQt6_DIR=$Qt6_DIR \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared \
          -DCMAKE_FIND_DEBUG_MODE=ON
          
    - name: Build
      working-directory: build-android
      run: cmake --build . --config Release -j$(nproc)
      
    - name: Create APK
      working-directory: build-android
      run: |
        $CMAKE_PREFIX_PATH/bin/androiddeployqt \
          --input android-SerialDebugger-deployment-settings.json \
          --output android-build \
          --android-platform android-30 \
          --jdk $JAVA_HOME \
          --gradle
          
    - name: Sign APK
      working-directory: build-android/android-build/build/outputs/apk/release
      run: |
        # Create temporary keystore
        keytool -genkey -v -keystore release.keystore \
          -alias release -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass android -keypass android \
          -dname "CN=SerialDebugger, OU=Dev, O=HansCNC, L=Shanghai, S=Shanghai, C=CN"
        
        # Sign APK
        $ANDROID_SDK_ROOT/build-tools/30.0.3/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out SerialDebugger-signed.apk \
          android-build-release-unsigned.apk
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-Android-APK
        path: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk

  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-22.04
    needs: build-android  # 等待 Android 构建完成
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip cmake ninja-build
        
    - name: Install Emscripten
      run: |
        cd $HOME
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install 2.0.14
        ./emsdk activate 2.0.14
        
    - name: Install Qt for WebAssembly
      run: |
        pip3 install aqtinstall==3.1.*
        # Install Qt with all available modules
        aqt install-qt linux desktop 5.15.2 wasm_32 -m qtcharts qtnetworkauth qtsvg || aqt install-qt linux desktop 5.15.2 wasm_32 || true
        
        QT_ROOT=$(find $PWD -type d -name "wasm_32" 2>/dev/null | head -1)
        if [ -n "$QT_ROOT" ]; then
          echo "Qt installed at: $QT_ROOT"
          ls -la $QT_ROOT/lib/cmake/ 2>/dev/null || echo "Cannot list cmake modules"
        else
          echo "ERROR: Qt installation not found!"
          exit 1
        fi
        
    - name: Build WebAssembly
      run: |
        source $HOME/emsdk/emsdk_env.sh
        
        QT_ROOT=$(find $PWD -type d -name "wasm_32" 2>/dev/null | head -1)
        echo "Found Qt at: $QT_ROOT"
        
        if [ -z "$QT_ROOT" ]; then
          echo "ERROR: Qt installation not found!"
          exit 1
        fi
        
        export Qt5_DIR=$QT_ROOT/lib/cmake/Qt5
        export PATH=$QT_ROOT/bin:$PATH
        
        # Check and create missing Qt module configs if needed
        for MODULE in Svg Zlib Network EventDispatcherSupport FontDatabaseSupport EglSupport; do
          if [ ! -d "$QT_ROOT/lib/cmake/Qt5$MODULE" ]; then
            echo "Creating dummy Qt5$MODULE config..."
            mkdir -p $QT_ROOT/lib/cmake/Qt5$MODULE
            cat > $QT_ROOT/lib/cmake/Qt5$MODULE/Qt5${MODULE}Config.cmake << 'EOFCONFIG'
        add_library(Qt5::$MODULE INTERFACE IMPORTED)
        set(Qt5${MODULE}_FOUND TRUE)
        set(Qt5${MODULE}_VERSION_STRING "5.15.2")
        EOFCONFIG
            cat > $QT_ROOT/lib/cmake/Qt5$MODULE/Qt5${MODULE}ConfigVersion.cmake << 'EOFVERSION'
        set(PACKAGE_VERSION "5.15.2")
        set(PACKAGE_VERSION_COMPATIBLE TRUE)
        set(PACKAGE_VERSION_EXACT FALSE)
        EOFVERSION
          fi
        done
        
        mkdir build-wasm
        cd build-wasm
        
        export QT_ROOT=$QT_ROOT
        
        emcmake cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="$QT_ROOT;$QT_ROOT/lib/cmake" \
          -DQt5_DIR="$QT_ROOT/lib/cmake/Qt5" \
          -DQt5Core_DIR="$QT_ROOT/lib/cmake/Qt5Core" \
          -DQt5Gui_DIR="$QT_ROOT/lib/cmake/Qt5Gui" \
          -DQt5Widgets_DIR="$QT_ROOT/lib/cmake/Qt5Widgets" \
          -DQt5Svg_DIR="$QT_ROOT/lib/cmake/Qt5Svg" \
          -DQt5Zlib_DIR="$QT_ROOT/lib/cmake/Qt5Zlib" \
          -DQt5Network_DIR="$QT_ROOT/lib/cmake/Qt5Network" \
          -DQt5EventDispatcherSupport_DIR="$QT_ROOT/lib/cmake/Qt5EventDispatcherSupport" \
          -DQt5FontDatabaseSupport_DIR="$QT_ROOT/lib/cmake/Qt5FontDatabaseSupport" \
          -DQt5EglSupport_DIR="$QT_ROOT/lib/cmake/Qt5EglSupport" \
          -G Ninja
          
        cmake --build . --config Release -j2
        
    - name: Prepare deployment
      run: |
        mkdir -p deploy
        cp build-wasm/bin/SerialDebugger.* deploy/
        cp index.html deploy/
        cp lang_*.ini deploy/
        cp styles.qss deploy/
        
    - name: Upload WebAssembly build
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-WebAssembly
        path: deploy/
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        force_orphan: true
