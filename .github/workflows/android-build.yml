name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        host: 'linux'
        target: 'android'
        arch: 'android_arm64_v8a'
        modules: 'qtserialport'
        cache: true
        
    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android NDK
      run: |
        echo "y" | sdkmanager "ndk;21.4.7075529"
        
    - name: Set up environment variables
      run: |
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/21.4.7075529" >> $GITHUB_ENV
        
    - name: Create build directory
      run: mkdir build-android
      
    - name: Configure CMake
      working-directory: build-android
      run: |
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21 \
          -DCMAKE_PREFIX_PATH=$Qt5_DIR \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared
          
    - name: Build
      working-directory: build-android
      run: cmake --build . --config Release -j$(nproc)
      
    - name: Create APK
      working-directory: build-android
      run: |
        $Qt5_DIR/bin/androiddeployqt \
          --input android-SerialDebugger-deployment-settings.json \
          --output android-build \
          --android-platform android-30 \
          --jdk $JAVA_HOME \
          --gradle
          
    - name: Sign APK
      working-directory: build-android/android-build/build/outputs/apk/release
      run: |
        # 创建临时密钥库（生产环境应使用安全的密钥）
        keytool -genkey -v -keystore release.keystore \
          -alias release -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass android -keypass android \
          -dname "CN=SerialDebugger, OU=Dev, O=HansCNC, L=Shanghai, S=Shanghai, C=CN"
        
        # 签名 APK
        $ANDROID_SDK_ROOT/build-tools/30.0.3/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out SerialDebugger-signed.apk \
          android-build-release-unsigned.apk
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-Android-APK
        path: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
