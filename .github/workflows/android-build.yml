name: Build Android APK (Manual Only)

on:
  # 禁用自动触发，仅保留手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Install Qt for Android
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install aqtinstall==3.1.*
        
        # Install Qt 6.5.3 for Android
        python3 -m aqt install-qt linux android 6.5.3 android_arm64_v8a
        
        # Set Qt environment
        echo "Qt6_DIR=$PWD/6.5.3/android_arm64_v8a" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$PWD/6.5.3/android_arm64_v8a" >> $GITHUB_ENV
        echo "$PWD/6.5.3/android_arm64_v8a/bin" >> $GITHUB_PATH
        
    - name: Install Android SDK and NDK
      run: |
        # Install Android SDK command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p $HOME/android-sdk/cmdline-tools
        mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        
        # Set Android SDK environment
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        
        # Accept licenses and install components
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3" "ndk;21.4.7075529"
        
        # Set NDK environment
        echo "ANDROID_NDK_ROOT=$HOME/android-sdk/ndk/21.4.7075529" >> $GITHUB_ENV
        
    - name: Create build directory
      run: mkdir build-android
      
    - name: Configure CMake
      working-directory: build-android
      run: |
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-23 \
          -DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH \
          -DCMAKE_BUILD_TYPE=Release \
          -DANDROID_STL=c++_shared
          
    - name: Build
      working-directory: build-android
      run: cmake --build . --config Release -j$(nproc)
      
    - name: Create APK
      working-directory: build-android
      run: |
        $CMAKE_PREFIX_PATH/bin/androiddeployqt \
          --input android-SerialDebugger-deployment-settings.json \
          --output android-build \
          --android-platform android-30 \
          --jdk $JAVA_HOME \
          --gradle
          
    - name: Sign APK
      working-directory: build-android/android-build/build/outputs/apk/release
      run: |
        # Create temporary keystore
        keytool -genkey -v -keystore release.keystore \
          -alias release -keyalg RSA -keysize 2048 -validity 10000 \
          -storepass android -keypass android \
          -dname "CN=SerialDebugger, OU=Dev, O=HansCNC, L=Shanghai, S=Shanghai, C=CN"
        
        # Sign APK
        $ANDROID_SDK_ROOT/build-tools/30.0.3/apksigner sign \
          --ks release.keystore \
          --ks-key-alias release \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out SerialDebugger-signed.apk \
          android-build-release-unsigned.apk
          
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SerialDebugger-Android-APK
        path: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build-android/android-build/build/outputs/apk/release/SerialDebugger-signed.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
