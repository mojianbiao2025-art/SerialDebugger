<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Qt WebAssembly æ¸²æŸ“æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #333;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        #canvas {
            border: 2px solid #333;
            display: block;
            margin: 20px auto;
            background: #f5f5f5;
        }
        #log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 4px;
        }
        .log-entry {
            margin: 2px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ Qt WebAssembly æ¸²æŸ“è¯Šæ–­</h1>
        
        <div class="info">
            <strong>æµ‹è¯•ç›®çš„ï¼š</strong>æ£€æŸ¥ Qt åº”ç”¨æ˜¯å¦æ­£ç¡®æ¸²æŸ“åˆ° canvas
        </div>

        <div id="status" class="info">
            æ­£åœ¨åˆå§‹åŒ–...
        </div>

        <div>
            <button onclick="checkCanvas()">æ£€æŸ¥ Canvas</button>
            <button onclick="checkModule()">æ£€æŸ¥ Module</button>
            <button onclick="forceRepaint()">å¼ºåˆ¶é‡ç»˜</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <canvas id="canvas" width="1200" height="800"></canvas>

        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <div id="log"></div>
    </div>

    <script>
        var logEntries = [];

        function log(message, type) {
            type = type || 'info';
            var timestamp = new Date().toLocaleTimeString();
            var entry = '[' + timestamp + '] ' + message;
            logEntries.push(entry);
            
            var logDiv = document.getElementById('log');
            var entryDiv = document.createElement('div');
            entryDiv.className = 'log-entry';
            entryDiv.textContent = entry;
            logDiv.appendChild(entryDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(entry);
        }

        function updateStatus(message, type) {
            var statusDiv = document.getElementById('status');
            statusDiv.className = type || 'info';
            statusDiv.innerHTML = '<strong>çŠ¶æ€ï¼š</strong>' + message;
        }

        function checkCanvas() {
            var canvas = document.getElementById('canvas');
            log('=== Canvas æ£€æŸ¥ ===');
            log('Canvas å…ƒç´ : ' + (canvas ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
            log('Canvas å®½åº¦: ' + canvas.width);
            log('Canvas é«˜åº¦: ' + canvas.height);
            log('CSS å®½åº¦: ' + canvas.offsetWidth);
            log('CSS é«˜åº¦: ' + canvas.offsetHeight);
            log('Display: ' + window.getComputedStyle(canvas).display);
            log('Visibility: ' + window.getComputedStyle(canvas).visibility);
            
            // Check canvas content
            var ctx = canvas.getContext('2d');
            if (ctx) {
                log('2D Context: å¯ç”¨');
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var hasContent = false;
                for (var i = 0; i < imageData.data.length; i += 4) {
                    if (imageData.data[i+3] > 0) {
                        hasContent = true;
                        break;
                    }
                }
                log('Canvas å†…å®¹: ' + (hasContent ? 'æœ‰åƒç´ æ•°æ®' : 'å®Œå…¨é€æ˜/ç©ºç™½'));
            }
            
            // Check WebGL
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            log('WebGL Context: ' + (gl ? 'å¯ç”¨' : 'ä¸å¯ç”¨'));
        }

        function checkModule() {
            log('=== Module æ£€æŸ¥ ===');
            log('Module å¯¹è±¡: ' + (typeof Module !== 'undefined' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
            if (typeof Module !== 'undefined') {
                log('Module.qtCanvasElements: ' + (Module.qtCanvasElements ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'));
                if (Module.qtCanvasElements) {
                    log('Canvas å…ƒç´ æ•°é‡: ' + Module.qtCanvasElements.length);
                }
                log('Module.canvas (deprecated): ' + (Module.canvas ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
                log('Module.print: ' + (typeof Module.print === 'function' ? 'å‡½æ•°' : 'æœªå®šä¹‰'));
                log('Module.ccall: ' + (typeof Module.ccall === 'function' ? 'å‡½æ•°' : 'æœªå®šä¹‰'));
            }
        }

        function forceRepaint() {
            log('=== å°è¯•å¼ºåˆ¶é‡ç»˜ ===');
            var canvas = document.getElementById('canvas');
            
            // Method 1: Trigger resize event
            window.dispatchEvent(new Event('resize'));
            log('è§¦å‘ resize äº‹ä»¶');
            
            // Method 2: Toggle display
            canvas.style.display = 'none';
            setTimeout(function() {
                canvas.style.display = 'block';
                log('åˆ‡æ¢ display å±æ€§');
            }, 100);
            
            // Method 3: Call Qt repaint if available
            if (typeof Module !== 'undefined' && Module._qt_force_repaint) {
                Module._qt_force_repaint();
                log('è°ƒç”¨ Qt é‡ç»˜å‡½æ•°');
            } else {
                log('Qt é‡ç»˜å‡½æ•°ä¸å¯ç”¨');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            logEntries = [];
        }

        // Initialize
        log('é¡µé¢åŠ è½½å®Œæˆ');
        log('æµè§ˆå™¨: ' + navigator.userAgent);
        log('åè®®: ' + window.location.protocol);

        var canvas = document.getElementById('canvas');
        canvas.addEventListener("webglcontextlost", function(e) {
            log('WebGL ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼', 'error');
            updateStatus('WebGL ä¸Šä¸‹æ–‡ä¸¢å¤±', 'error');
            e.preventDefault();
        }, false);

        var Module = {
            preRun: [],
            postRun: [],
            print: function(text) {
                log('[Qt stdout] ' + text);
            },
            printErr: function(text) {
                log('[Qt stderr] ' + text, 'error');
            },
            qtCanvasElements: [canvas],
            arguments: [],
            setStatus: function(text) {
                if (text) {
                    log('[Status] ' + text);
                    updateStatus(text, 'info');
                } else {
                    log('[Status] åŠ è½½å®Œæˆ');
                    updateStatus('åº”ç”¨ç¨‹åºåŠ è½½å®Œæˆ', 'success');
                    
                    // Auto-check after load
                    setTimeout(function() {
                        checkCanvas();
                        checkModule();
                    }, 1000);
                }
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                var message = left ? 
                    'åŠ è½½ä¾èµ–é¡¹ (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 
                    'æ‰€æœ‰ä¾èµ–é¡¹å·²åŠ è½½';
                Module.setStatus(message);
            },
            onRuntimeInitialized: function() {
                log('âœ“ WebAssembly è¿è¡Œæ—¶åˆå§‹åŒ–æˆåŠŸ');
                updateStatus('WebAssembly è¿è¡Œæ—¶å·²åˆå§‹åŒ–', 'success');
            }
        };

        Module.setStatus('æ­£åœ¨ä¸‹è½½åº”ç”¨ç¨‹åº...');
        
        window.onerror = function(message, source, lineno, colno, error) {
            log('JavaScript é”™è¯¯: ' + message, 'error');
            if (source) log('  ä½ç½®: ' + source + ':' + lineno);
            updateStatus('å‘ç”Ÿ JavaScript é”™è¯¯', 'error');
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            log('Promise é”™è¯¯: ' + event.reason, 'error');
            updateStatus('å‘ç”Ÿ Promise é”™è¯¯', 'error');
        });

        // Auto-check periodically
        setInterval(function() {
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            if (ctx) {
                var imageData = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1);
                if (imageData.data[3] > 0) {
                    log('æ£€æµ‹åˆ° canvas å†…å®¹æ›´æ–°');
                    updateStatus('Canvas æœ‰å†…å®¹æ¸²æŸ“', 'success');
                }
            }
        }, 5000);
    </script>
    <script src="SerialDebugger.js" onerror="log('æ— æ³•åŠ è½½ SerialDebugger.js', 'error'); updateStatus('æ— æ³•åŠ è½½åº”ç”¨ç¨‹åº', 'error');"></script>
</body>
</html>
