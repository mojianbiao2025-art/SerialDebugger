# Qt WebAssembly 最小化测试

## 🎯 目的

创建一个最简单的 Qt 应用来测试 WebAssembly 渲染是否工作。

## 📋 问题现状

- ✅ WebAssembly 加载成功
- ✅ Canvas 尺寸正确
- ✅ WebGL 可用
- ✅ Module 配置正确
- ❌ Qt 界面元素不显示

## 🔍 可能的原因

### 1. MainWindow 太复杂
`mainwindow.cpp` 包含大量代码：
- Android 特定布局
- 串口配置
- 绘图功能
- 样式表加载
- 语言切换

可能某个部分导致渲染失败。

### 2. 资源文件问题
- styles.qss 可能有问题
- 图标文件可能加载失败
- 语言文件可能有问题

### 3. Qt 事件循环问题
- 窗口创建了但没有正确显示
- 事件循环没有正确启动

## ✅ 解决方案：最小化测试

### 创建最简单的 Qt 应用

`main_minimal.cpp` 包含：
- 一个红色背景的窗口
- 一个蓝色背景的大标签
- 一个按钮
- 详细的调试日志

### 如何使用

#### 步骤 1：临时替换 main.cpp

```bash
# 备份原始文件
cp main.cpp main_original.cpp

# 使用最小化版本
cp main_minimal.cpp main.cpp
```

#### 步骤 2：修改 CMakeLists.txt

注释掉不需要的源文件：

```cmake
set(PROJECT_SOURCES
    main.cpp
    # mainwindow.cpp
    # mainwindow.h
    # mainwindow.ui
    # translations.h
    # translations.cpp
    # plotwidget.h
    # plotwidget.cpp
    # resources.qrc
)
```

#### 步骤 3：构建

```bash
cd build-wasm
ninja
```

#### 步骤 4：测试

访问应用，应该看到：
- 红色背景的窗口
- 蓝色背景的白色大文字："Hello Qt WebAssembly!"
- 一个按钮

如果看到这些，说明 Qt 渲染工作正常，问题在于 MainWindow 的复杂性。

#### 步骤 5：查看日志

控制台应该显示：
```
=== 应用程序启动 ===
QApplication 已创建
窗口已创建，背景色：红色
标签已添加
按钮已添加
窗口已调用 show()
窗口可见性: true
窗口尺寸: QSize(800, 600)
=== 进入事件循环 ===
```

## 🔍 诊断结果

### 结果 A：最小化应用可以显示 ✅

**说明：** Qt WebAssembly 渲染正常工作，问题在于 MainWindow 的代码。

**下一步：**
1. 逐步简化 MainWindow
2. 移除 Android 特定代码
3. 移除样式表加载
4. 移除资源文件依赖

### 结果 B：最小化应用也不显示 ❌

**说明：** Qt WebAssembly 本身有问题。

**可能原因：**
1. Qt 版本不兼容
2. Emscripten 版本不兼容
3. 链接标志不正确
4. 浏览器环境问题

**下一步：**
1. 检查 Qt 版本（应该是 5.15.2）
2. 检查 Emscripten 版本（应该是 1.39.20）
3. 尝试使用 Qt 官方示例

## 🔧 简化 MainWindow 的步骤

如果最小化应用可以显示，按以下步骤简化 MainWindow：

### 步骤 1：移除 Android 特定代码

```cpp
// 注释掉所有 #ifdef Q_OS_ANDROID 块
```

### 步骤 2：移除样式表

```cpp
// 注释掉 loadStyleSheet()
```

### 步骤 3：移除资源文件

```cpp
// 注释掉图标加载
// setWindowIcon(QIcon(":/icons/app_icon.ico"));
```

### 步骤 4：简化 UI

只保留基本控件：
- 一个标签
- 一个按钮
- 一个文本框

### 步骤 5：逐步添加功能

确认基本界面可以显示后，逐步添加：
1. 串口配置控件
2. 发送/接收区域
3. 绘图功能
4. 样式表
5. 语言切换

## 📊 当前 MainWindow 的复杂度

```
mainwindow.cpp: 约 1000+ 行代码
- Android 特定布局
- 串口配置（波特率、数据位等）
- HEX 模式
- 时间戳
- 自动发送
- 命令列表
- 6 通道绘图
- 语言切换
- 样式表加载
```

这么复杂的应用，任何一个部分出错都可能导致整个界面不显示。

## 🎯 推荐方案

### 方案 1：使用最小化测试（推荐）

1. 先确认 Qt WebAssembly 基本功能正常
2. 再逐步添加功能
3. 每次添加后测试

### 方案 2：检查 MainWindow 日志

在 MainWindow 构造函数中添加大量 qDebug()：
```cpp
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
{
    qDebug() << "=== MainWindow 构造开始 ===";
    
    qDebug() << "创建 UI...";
    ui->setupUi(this);
    qDebug() << "UI 创建完成";
    
    qDebug() << "设置窗口图标...";
    setWindowIcon(QIcon(":/icons/app_icon.ico"));
    qDebug() << "图标设置完成";
    
    // ... 每个步骤都添加日志
}
```

查看哪一步失败了。

### 方案 3：使用 Qt 官方示例

下载 Qt 官方的 WebAssembly 示例，确认环境配置正确。

## 📝 下一步操作

1. **立即测试：** 使用 main_minimal.cpp
2. **查看日志：** 检查控制台输出
3. **根据结果：** 决定是简化 MainWindow 还是检查环境

---

**更新时间：** 2025-02-03  
**状态：** 需要最小化测试确认问题范围
